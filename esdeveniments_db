-- Creació de la base de dades
CREATE DATABASE esdeveniments_db;
USE esdeveniments_db;

-- 1. Taula: `usuaris`
CREATE TABLE usuaris (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(100) NOT NULL,
    cognoms VARCHAR(100) NOT NULL,
    nom_dusuari VARCHAR(100) UNIQUE NOT NULL,
    imatge_perfil VARCHAR(255), -- URL o ruta a la imatge de perfil
    email VARCHAR(255) UNIQUE NOT NULL,
    contrasenya VARCHAR(255) NOT NULL, -- Afegit per a autenticació
    rol ENUM('usuari', 'administrador') DEFAULT 'usuari' -- Permet definir rols d'usuari
);

-- 2. Taula: `categories`
CREATE TABLE categories (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(100) UNIQUE NOT NULL
);

-- 3. Taula: `esdeveniments`
CREATE TABLE esdeveniments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    titol VARCHAR(255) NOT NULL,
    latitud DECIMAL(9, 6) NOT NULL,
    longitud DECIMAL(9, 6) NOT NULL,
    descripcio TEXT NOT NULL,
    imatges JSON, -- Guardar múltiples imatges en format JSON
    tipus ENUM('Interior', 'Aire lliure', 'Xerrada', 'Jornada') NOT NULL,
    data DATE NOT NULL,
    hora TIME NOT NULL,
    id_categoria INT,
    num_visualitzacions INT DEFAULT 0,
    id_usuari INT,
    FOREIGN KEY (id_categoria) REFERENCES categories(id) ON DELETE SET NULL, -- Relació amb categories
    FOREIGN KEY (id_usuari) REFERENCES usuaris(id) ON DELETE SET NULL -- Relació amb usuaris
);

-- 4. Taula: `comentaris`
CREATE TABLE comentaris (
    id INT AUTO_INCREMENT PRIMARY KEY,
    id_esdeveniment INT,
    contingut TEXT NOT NULL,
    estat ENUM('pendent', 'publicat') NOT NULL DEFAULT 'pendent',
    data_creacio TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    id_usuari INT,
    FOREIGN KEY (id_esdeveniment) REFERENCES esdeveniments(id) ON DELETE CASCADE, -- Relació amb esdeveniments
    FOREIGN KEY (id_usuari) REFERENCES usuaris(id) ON DELETE SET NULL -- Relació amb usuaris
);

-- 5. Taula: `valoracions`
CREATE TABLE valoracions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    id_esdeveniment INT,
    valoracio INT CHECK (valoracio >= 1 AND valoracio <= 5),
    id_usuari INT,
    data TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_esdeveniment) REFERENCES esdeveniments(id) ON DELETE CASCADE, -- Relació amb esdeveniments
    FOREIGN KEY (id_usuari) REFERENCES usuaris(id) ON DELETE CASCADE -- Relació amb usuaris
);

-- 6. Taula: `consells`
CREATE TABLE consells (
    id INT AUTO_INCREMENT PRIMARY KEY,
    titol VARCHAR(255) NOT NULL,
    descripcio_breu TEXT NOT NULL,
    text_explicatiu TEXT NOT NULL, -- Preferiblement en format Markdown
    etiquetes JSON -- Guardar múltiples etiquetes en format JSON
);

-- 7. Taula: `anuncis`
CREATE TABLE anuncis (
    id INT AUTO_INCREMENT PRIMARY KEY,
    titol VARCHAR(255) NOT NULL,
    descripcio TEXT NOT NULL, -- Preferiblement en format Markdown
    imatges JSON, -- Guardar múltiples imatges en format JSON
    categoria INT,
    estat ENUM('esborrany', 'públic', 'caducat', 'esborrat') NOT NULL DEFAULT 'esborrany',
    id_usuari INT,
    FOREIGN KEY (categoria) REFERENCES categories(id) ON DELETE SET NULL, -- Relació amb categories
    FOREIGN KEY (id_usuari) REFERENCES usuaris(id) ON DELETE SET NULL -- Relació amb usuaris
);
